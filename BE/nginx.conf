# -----------------------------
# GIAI ĐOẠN 1: BUILD (Cài đặt dependencies)
# -----------------------------
# Sử dụng base image Node.js Alpine để giảm kích thước Image
FROM node:20-alpine AS build
WORKDIR /usr/src/app

# Sao chép file cấu hình và cài đặt dependencies
COPY package.json package-lock.json ./ 
RUN npm install

# -----------------------------
# GIAI ĐOẠN 2: PHỤC VỤ (Express + Nginx)
# -----------------------------
# Sử dụng Nginx Alpine làm base image cho giai đoạn cuối
FROM nginx:alpine AS final

# Xóa file cấu hình Nginx mặc định
RUN rm /etc/nginx/conf.d/default.conf

# Sao chép cấu hình Nginx đã tùy chỉnh (xem mục 2)
COPY nginx.conf /etc/nginx/conf.d/default.conf

# -----------------------------
# GIAI ĐOẠN 3: RUNTIME (Chạy Express)
# -----------------------------
# Sử dụng Node.js Alpine (lại) để chạy Express.js.
# Chúng ta dùng một container Nginx (final) và một container Express (runtime) 
# để tách biệt trách nhiệm (Nếu bạn muốn 1 container duy nhất, cần sử dụng Docker Compose)

FROM node:20-alpine AS runtime
WORKDIR /usr/src/app

# Sao chép node_modules từ giai đoạn build
COPY --from=build /usr/src/app/node_modules ./node_modules

# Sao chép mã nguồn Express.js
COPY . .

# Cổng mặc định cho Express.js (Express sẽ lắng nghe trên cổng này)
EXPOSE 8080 

# Chạy ứng dụng Express.js
CMD ["npm", "start"]
# Đảm bảo script 'start' trong package.json của bạn là lệnh khởi động server chính xác